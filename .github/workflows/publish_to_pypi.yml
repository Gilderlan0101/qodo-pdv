# Nome do fluxo de trabalho (aparece na aba 'Actions' do GitHub)
name: Publicar no PyPI

# Define quando este fluxo de trabalho serÃ¡ executado
on:
  # Executa sempre que um novo 'release' for criado
  release:
    types: [published]
  # Permite executar manualmente
  workflow_dispatch:

# PermissÃµes necessÃ¡rias para o trabalho de deploy
permissions:
  contents: write # NecessÃ¡rio para fazer checkout do cÃ³digo
  id-token: write # NecessÃ¡rio para autenticaÃ§Ã£o no PyPI (OIDC) - MÃ©todo moderno e seguro

jobs:
  # O trabalho principal para construir e fazer o deploy
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/qodo # Substitua 'qodo' pelo nome correto se for diferente

    steps:
    - name: â¬‡ï¸ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: âš™ï¸ Configurar Python (3.x)
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: ğŸ› ï¸ Instalar dependÃªncias de build
      run: |
        # Instala build, setuptools e wheel para criar os pacotes
        python -m pip install --upgrade pip
        pip install build setuptools wheel

    - name: ğŸ—ï¸ Construir o pacote (sdist e wheel)
      run: python -m build

    - name: ğŸ”‘ Configurar AutenticaÃ§Ã£o PyPI (OIDC)
      # Usa a Action oficial para configurar o ambiente para autenticaÃ§Ã£o de token
      uses: pypi-actions/configure-poetry@v1
      with:
        # Usa o nome do ambiente que definimos acima, que deve ter o token PyPI
        pypi_token: ${{ secrets.PYPI_API_TOKEN }} 
        
    - name: ğŸš€ Publicar no PyPI
      uses: pypi-actions/upload-and-release@v2
      with:
        # PadrÃ£o para arquivos de distribuiÃ§Ã£o construÃ­dos
        # Certifique-se de que os nomes de arquivo correspondam ao que `python -m build` gera
        # Geralmente fica em 'dist/'
        
        # Este Ã© o segredo que vocÃª deve configurar no GitHub (veja o passo 2)
        pypi_token: ${{ secrets.PYPI_API_TOKEN }}
